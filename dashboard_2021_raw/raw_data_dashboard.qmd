---
title: "2021 raw data dashboard"
title-block-banner: true
format: 
  html:
    page-layout: full
server: shiny
---

<style>
/* === Title Banner === */
.quarto-title-banner {
  position: relative;
  background-image: url("images/genx.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  min-height: 75px;
  color: white;
  margin-bottom: 0;
}

.quarto-title-banner .title,
.quarto-title-banner .subtitle,
.quarto-title-banner .author {
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
  padding: 0 10vw;
}

/* === Tabs === */
.nav-tabs .nav-link {
  color: black;
}

.nav-tabs .nav-link.active {
  color: black;
  font-weight: 600;
  border-bottom: 2px solid black;
}

/* === Sidebar Inputs === */
.checkbox label,
.radio label {
  color: #444;
}

.form-check-input:checked,
.checkbox input[type="checkbox"]:checked,
.radio input[type="radio"]:checked {
  background-color: #444;
  border-color: #444;
}

.form-check-input:focus,
.checkbox input[type="checkbox"]:focus,
.radio input[type="radio"]:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3);
}

/* SliderInput */
.irs--shiny .irs-bar,
.irs--shiny .irs-bar-edge,
.irs--shiny .irs-single,
.irs--shiny .irs-handle > i:first-child {
  background: #444;
  border-color: #444;
}

/* Date picker */
.datepicker table tr td.active,
.datepicker table tr td.active:hover,
.datepicker table tr td.active.disabled,
.datepicker table tr td.active.disabled:hover {
  background-color: #444;
  border-color: #444;
}

/* Selectize Inputs */
.selectize-input.focus {
  border-color: #444;
  box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25);
}

/* Buttons */
.btn-primary,
.btn-primary:focus,
.btn-primary:hover {
  background-color: #444;
  border-color: #444;
}
</style>

```{r, message=FALSE, warning=FALSE}
#| context: setup

library(tidyverse)
library(plotly)
source(here::here("R","group_fun.R"))

chamber_levels = c("c_1_amb", "c_2_amb", "c_3_e0.75", "c_4_e1.5", "c_5_e2.25",
                   "c_6_e2.25", "c_7_e3.0", "c_8_e3.75", "c_9_e3.75",
                   "c_10_e4.5", "c_11_e5.25", "c_12_e6.0")

color.gradient=c('blue4','blue3','turquoise4','lightseagreen',
                 'mediumseagreen','limegreen','yellowgreen','yellow2',
                 'darkgoldenrod2','darkorange2','orangered1','red2')

#For testing
input <- list()
input$gases <- c("CH₄","CO₂","N₂O")
input$today <- Sys.Date()
input$days_to_plot <- 3
input$daily <- "Hourly"
input$smooth <- "Measured"
input$time_date <- "2021-07-01"
input$time_hour <- 11
```

::: {.row}

::: {.panel-tabset}

## By time

```{r}
#| panel: fill
splitLayout(
  cellWidths = c("50%", "50%"),
  
  dateInput("time_date","Date",
            value = "2021-07-01",
            min = "2021-04-14",
            max = "2021-12-31"),
  
  sliderInput("time_hour","Hour",
              min = 0, max = 24,
              value = 11)
)
plotlyOutput('plot_time', height = 420)

```

## By chamber

```{r}
#| panel: fill
splitLayout(
  cellWidths = c("50%", "50%"),
  
  dateInput("raw_date","Date",
            value = "2021-07-01",
            min = "2021-04-14",
            max = "2021-12-31"),
  
  selectInput("raw_chamber", "Chamber",
              choices = chamber_levels)
)
plotlyOutput('plot_raw', height = 420)

```

:::

:::

```{r}
#| context: server

#Code for plots
################ Raw data ####################
raw_comb <- read_csv(here::here("processed_data","raw_comb.csv"))
  
output$plot_raw <- renderPlotly({
  raw_plot <- raw_comb %>%
    filter(as.Date(TIMESTAMP) == input$raw_date,
           Chamber == input$raw_chamber)
  
  p1 <- raw_plot %>%
    ggplot(aes(x = change_s, y = value, 
               color = used)) +
    geom_point(size = .9) +
    geom_smooth(method = "lm", se = F, color = "red",
                data = . %>% filter(used == "yes",
                                    retained == "yes"), 
                linewidth = 0.5) +
    scale_color_manual(values = c("black", "grey80"),
                       breaks = c("yes", "no"))+
    ylab("Value")+
    facet_grid(gas~label, scales = "free") +
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 30, vjust = 1.0, hjust = 1.0),
          legend.position = "none",
          strip.background = element_rect(fill = "grey95", color = "grey"))+
    ggtitle(unique(raw_plot$Chamber))
  
  plotly::ggplotly(p1, tooltip=c("TIMESTEP", "value"))
})

output$plot_time <- renderPlotly({
  raw_plot <- raw_comb %>%
    filter(as.Date(TIMESTAMP) == input$time_date,
           hour(TIMESTAMP) == as.numeric(input$time_hour))
  
  p1 <- raw_plot %>%
    ungroup() %>%
    mutate(min_TS = min(TIMESTAMP),
           secs = as.numeric(difftime(TIMESTAMP, min_TS, units = "secs"))) %>%
    ggplot(aes(x = secs, y = value, 
               alpha = used, shape = used,
               color = Chamber)) +
    geom_point(size = .9) +
    geom_smooth(aes(group = paste(group2, gas, Chamber), x = secs, y = value), 
                method = "lm", se = F, color = "black",
                data = . %>% filter(used == "yes",
                                    retained == "yes"), 
                linewidth = 0.5) +
    scale_alpha_manual(values = c(1,0.1),
                       breaks = c("yes", "no"))+
    scale_color_manual(values = color.gradient,
                       breaks = chamber_levels)+
    scale_shape_manual(values = c(21, 19),
                      breaks = c("no", "yes"))+
    ylab("Value")+
    xlab("Seconds since start time") +
    facet_wrap(~gas, scales = "free_y", ncol = 1) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 30, vjust = 1.0, hjust = 1.0),
          legend.position = "none",
          strip.background = element_rect(fill = "grey95", color = "grey"))+
    ggtitle(input$time_date)
  
  plotly::ggplotly(p1, tooltip=c("TIMESTEP", "value", "Chamber"))
})

data <- data_small[409:443, ]

data %>%
  mutate(date_time = strptime(TIMESTAMP,format='%F %T'),
         fDOY = as.numeric(julian(date_time,'2021-01-01')),
         CH4d_ppm = as.numeric(CH4d_ppm)) %>%
  ggplot(aes(x = fDOY, y = CH4d_ppm))+
  geom_point()+
  geom_smooth(method = "lm", data = .[-(1:10)])+
  geom_abline(intercept = -436.7266, slope = 3.5226514)

seq_along(data$TIMESTAMP)

gln_cutoffs[3,2]
```
