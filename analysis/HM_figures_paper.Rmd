---
title: "HM_figures"
author: "Abby Lewis"
date: "2026-01-20"
output: html_document
---

TO DO: 
- Interpolate fluxes
- Bring in EVI

Hot moments are important across all chambers (Figure 2)
The importance of hot moment events increases with median flux (Figure 3)
Because of hot moments, manual sampling underestimates fluxes (Figure 4)
Hot moments occur as water level rises (Figure 2, maybe also another)
However, the magnitude of methane emitted is poorly predicted by the magnitude of change in water level (Figure 5)

Load data and packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggridges)

chamber_levels2 = c("Ch. 1 (+0 ºC)", "Ch. 2 (+0 ºC)", "Ch. 3 (+0.75 ºC)", 
                    "Ch. 4 (+1.5 ºC)", "Ch. 5 (+2.25 ºC)", "Ch. 6 (+2.25 ºC)", 
                    "Ch. 7 (+3.0 ºC)", "Ch. 8 (+3.75 ºC)", "Ch. 9 (+3.75 ºC)",
                   "Ch. 10 (+4.5 ºC)", "Ch. 11 (+5.25 ºC)", "Ch. 12 (+6.0 ºC)")

color.gradient=c('blue4','blue3','turquoise4','lightseagreen',
                 'mediumseagreen','limegreen','yellowgreen','yellow2',
                 'darkgoldenrod2','darkorange2','orangered1','red2')

part <- read_csv(here::here("processed_data", "partitioned_co2.csv")) %>%
  filter(is.na(CH4) | CH4 > -0.2) %>%
  mutate(CH4_umol_m2_h = CH4 * (60 * 60),
         MIU_VALVE = factor(MIU_VALVE, levels = 1:12, 
                            labels = chamber_levels2),
         date = as.Date(DateTime))

all <- read_csv("../processed_data/L0_for_dashboard.csv")
met <- read_csv("../processed_data/met_2025_dashboard.csv") 
wl <- read_csv("../processed_data/water_level_dashboard.csv")
```

Check qaqc

```{r}
p <- all %>%
  filter(date >= Sys.Date() - days(700)) %>%
  mutate(MIU_VALVE = factor(MIU_VALVE, levels = 1:12, 
                            labels = chamber_levels2)) %>%
  ggplot(aes(x = flux_start, y = CH4_init, color = MIU_VALVE))+
  geom_line()

plotly::ggplotly(p)

all %>%
  filter(date >= Sys.Date() - days(700)) %>%
  mutate(MIU_VALVE = factor(MIU_VALVE, levels = 1:12, 
                            labels = chamber_levels2)) %>%
  ggplot(aes(x = CH4_init, y = CH4_slope_ppm_per_day, color = MIU_VALVE))+
  geom_point(size = 0.5)

all %>%
  arrange(flux_start) %>%
  mutate(init_change = CH4_init - lag(CH4_init)) %>%
  filter(date >= Sys.Date() - days(700)) %>%
  mutate(MIU_VALVE = factor(MIU_VALVE, levels = 1:12, 
                            labels = chamber_levels2)) %>%
  ggplot(aes(x = init_change, y = CH4_slope_ppm_per_day, color = MIU_VALVE))+
  geom_point(size = 0.5)

```


Data summary (Figure 2)

```{r}
annual <- part %>%
  group_by(date, MIU_VALVE) %>%
  summarize(CH4_umol_m2_h = mean(CH4_umol_m2_h, na.rm = T)) %>%
  ggplot(aes(x = date, y = CH4_umol_m2_h, color = MIU_VALVE))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop("Daily mean"~CH[4]~"flux","(µmol"~m^-2~h^-1*")")))

annual_AT <- met %>%
  mutate(date = as.Date(TIMESTAMP)) %>%
  group_by(date) %>%
  summarize(AirTC_Avg = mean(AirTC_Avg, na.rm = T)) %>%
  ggplot(aes(x = date, y = AirTC_Avg))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop("Air temp."," (ºC)")))

gpp <- part %>%
  group_by(date, MIU_VALVE) %>%
  summarize(GPP = sum(GPP, na.rm = T)) %>%
  ggplot(aes(x = date, y = GPP, color = MIU_VALVE))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop("Daily mean"~CH[4]~"flux","(µmol"~m^-2~h^-1*")")))

resp <- part %>%
  group_by(date, MIU_VALVE) %>%
  summarize(R = sum(Reco, na.rm = T)) %>%
  ggplot(aes(x = date, y = R, color = MIU_VALVE))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop("Daily mean"~CH[4]~"flux","(µmol"~m^-2~h^-1*")")))

start_date <- "2025-03-27"
end_date <- "2025-04-06"

focal_ch4 <- part %>%
  filter(date %in% seq.Date(as.Date(start_date), as.Date(end_date), by = "1 day")) %>%
  ggplot(aes(x = DateTime, y = CH4_umol_m2_h, color = MIU_VALVE))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop(CH[4]~"flux ", "(µmol"~m^-2~h^-1*")")))

focal_wl <- wl %>%
  mutate(date = as.Date(TIMESTAMP)) %>%
  filter(date %in% seq.Date(as.Date(start_date), as.Date(end_date), by = "1 day")) %>%
  ggplot(aes(x = TIMESTAMP, y = Depth_cm))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop("Water level"," (cm)")))

focal_AT <- met %>%
  mutate(date = as.Date(TIMESTAMP)) %>%
  filter(date %in% seq.Date(as.Date(start_date), as.Date(end_date), by = "1 day")) %>%
  ggplot(aes(x = TIMESTAMP, y = AirTC_Avg))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_line(size = 0.5)+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25))+
  ylab(expression(atop("Air temp."," (ºC)")))

comb <- ggpubr::ggarrange(
  annual+
    guides(color = guide_legend(ncol = 4))+
    theme(legend.position = "bottom",
          legend.title.position = "top"), 
  patchwork::wrap_plots(focal_ch4 +
                      scale_x_datetime(date_breaks = "5 day",
                                       date_labels = "%d %b")+
                        theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              legend.position = "none"), 
                    focal_wl +
                      scale_x_datetime(date_breaks = "5 day",
                                       date_labels = "%d %b")+
                        theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              legend.position = "none"), 
                    focal_AT +
                      scale_x_datetime(date_breaks = "5 day",
                                       date_labels = "%d %b")+
                        theme(legend.position = "none"), 
                    ncol = 1), 
  ncol = 2, widths = c(1.7,1), labels = c("a", "b"),
  legend = "bottom", common.legend = T
)
comb
ggsave("../figures/Figure 2 - Data.jpg", dpi = 300, width = 6, height = 4)

comb <- ggpubr::ggarrange(
  patchwork::wrap_plots(annual+
                          guides(color = guide_legend(ncol = 4))+
                          theme(legend.position = "bottom",
                                legend.title.position = "top"), 
                        gpp +
                          theme(legend.position = "none"),
                        resp +
                          theme(legend.position = "none"),
                        annual_AT, 
                        ncol = 1, 
                        guides = "collect")+
    theme(legend.position = "bottom"),
  patchwork::wrap_plots(focal_ch4 +
                      scale_x_datetime(date_breaks = "5 day",
                                       date_labels = "%d %b")+
                        theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              legend.position = "none"), 
                    focal_wl +
                      scale_x_datetime(date_breaks = "5 day",
                                       date_labels = "%d %b")+
                        theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              legend.position = "none"), 
                    focal_AT +
                      scale_x_datetime(date_breaks = "5 day",
                                       date_labels = "%d %b")+
                        theme(legend.position = "none"), 
                    ncol = 1), 
  ncol = 2, widths = c(1.7,1), labels = c("a", "b")
)
comb
```

The importance of hot moment events increases with median flux (Figure 3)

```{r}
# Tried using R pacakage, but I'm skeptical of this because only a normal 
# distribution is implemented currently.
# devtools::install_github("https://github.com/jonathan-walter/hotspomoments")
#library(hotspomoments)
#
#hshmtest(part$CH4_umol_m2_h[!is.na(part$CH4_umol_m2_h)], "skewness")
#hshm_id <- hshmid(part$CH4_umol_m2_h[!is.na(part$CH4_umol_m2_h)], 
#                  criteria = "ref.normal", side="upper", thresh=0.95)
##Plot where in the distribution the HSHM are identified
#hist(part$CH4_umol_m2_h[!is.na(part$CH4_umol_m2_h)])
#points(part$CH4_umol_m2_h[!is.na(part$CH4_umol_m2_h)][hshm_id], 
#       rep(0,sum(hshm_id)), pch=19, col="red")
#
##Inspect HSHM observations
#hshm <- part[!is.na(part$CH4_umol_m2_h),][hshm_id,]

hm_df <- part %>%
  mutate(month = month(date)) %>%
  filter(!is.na(CH4_umol_m2_h)) %>%
  group_by(date) %>%
  filter(length(unique(MIU_VALVE)) == 12)

hot_moments <- hm_df %>%
  group_by(MIU_VALVE) %>%
  mutate(hot_moment_quant = ifelse(CH4_umol_m2_h > 
                                     quantile(CH4_umol_m2_h, 
                                              probs = 0.75, na.rm = TRUE),
                                   "hot", "not"),
         hot_moment_iqr = ifelse(CH4_umol_m2_h > 
                                     (1.5 * (quantile(CH4_umol_m2_h, 
                                              probs = 0.75, na.rm = TRUE) - 
                                        quantile(CH4_umol_m2_h, 
                                              probs = 0.25, na.rm = TRUE))),
                                   "hot", "not")) %>%
  summarize(median = median(CH4_umol_m2_h, na.rm = T),
            mean = mean(CH4_umol_m2_h, na.rm = T),
            sum = sum(CH4_umol_m2_h, na.rm = T),
            hot_sum = sum(CH4_umol_m2_h[hot_moment_iqr == "hot"], na.rm = T),
            hot_med = median(CH4_umol_m2_h[hot_moment_iqr == "hot"], na.rm = T),
            quant_95 = quantile(CH4_umol_m2_h, probs = 0.95, na.rm = TRUE))

# TO DO: what really belongs on y axis here? This is dependent on n of fluxes

hm <- hot_moments %>%
  ggplot(aes(x = median, y = hot_sum, fill = MIU_VALVE))+
  geom_point(color = "black", shape = 21, stroke = 0.5, size = 2)+
  scale_fill_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  ylab("Sum of hot moment fluxes (top 5%)")+
  xlab("Median flux")+
  theme(panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25),
        legend.position = "bottom",
        legend.title.position = "top")+
  guides(fill = guide_legend(ncol = 2))

ggsave("../figures/Figure 3 - HM.jpg", dpi = 300, width = 3.5, height = 4.5)

hot_moments %>%
  ggplot(aes(x = median, y = hot_sum/sum, fill = MIU_VALVE))+
  geom_point(color = "black", shape = 21, stroke = 0.5, size = 2)+
  scale_fill_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  ylab("Percent hot moment fluxes")+
  xlab("Median flux")+
  theme(panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25),
        legend.position = "bottom",
        legend.title.position = "top")+
  guides(fill = guide_legend(ncol = 2))

hm_df %>%
  group_by(MIU_VALVE) %>%
  mutate(hot_moment_quant = ifelse(CH4_umol_m2_h > 
                                     quantile(CH4_umol_m2_h, 
                                              probs = 0.95, na.rm = TRUE),
                                   "hot", "not"),
         hot_moment_iqr = ifelse(CH4_umol_m2_h > 
                                     (1.5 * (quantile(CH4_umol_m2_h, 
                                              probs = 0.75, na.rm = TRUE) - 
                                        quantile(CH4_umol_m2_h, 
                                              probs = 0.25, na.rm = TRUE))),
                                   "hot", "not")) %>%
  ggplot(aes(x = DateTime, y = CH4_umol_m2_h))+
  geom_point()+
  geom_point(data = . %>% filter(hot_moment_quant == "hot"), color = "red")+
  facet_wrap(~MIU_VALVE, scales = "free")
```

The importance of hot moment events increases with median flux (Figure 3) - rolling attempt

```{r}
hm_df <- part

library(slider)

BEFORE <- lubridate::days(5)
AFTER <- lubridate::days(5)

hm_ident <- hm_df %>%
  mutate(CH4_umol_m2_h = ifelse(CH4_umol_m2_h < 0, 0, CH4_umol_m2_h)) %>%
  arrange(MIU_VALVE, date) %>%
  group_by(MIU_VALVE) %>%
  mutate(
    roll_q75 = slide_index_dbl(
      CH4_umol_m2_h,
      date,
      ~ quantile(.x, probs = 0.75, na.rm = TRUE),
      .before = BEFORE,
      .after  = AFTER,
      .complete = T
    ),
    roll_q95 = slide_index_dbl(
      CH4_umol_m2_h,
      date,
      ~ quantile(.x, probs = 0.95, na.rm = TRUE),
      .before = BEFORE,
      .after  = AFTER,
      .complete = T
    ),
    roll_iqr = slide_index_dbl(
      CH4_umol_m2_h,
      date,
      ~ IQR(.x, na.rm = TRUE),
      .before = BEFORE,
      .after  = AFTER,
      .complete = T
    ),
    hot_moment_quant = ifelse(
      CH4_umol_m2_h > roll_q95,
      "hot", "not"
    ),
    hot_moment_iqr = ifelse(
      CH4_umol_m2_h > (roll_q75 + 1.5 * roll_iqr),
      "hot", "not"
    ),
    roll_sum = slide_index_dbl(
      CH4_umol_m2_h,
      date,
      ~ sum(.x, na.rm = TRUE),
      .before = BEFORE,
      .after  = AFTER,
      .complete = T
    ),
    hm_quant = ifelse(hot_moment_quant == "hot",
                      CH4_umol_m2_h,
                      0),
    hm_iqr = ifelse(hot_moment_iqr == "hot",
                      CH4_umol_m2_h,
                      0),
    roll_sum_iqr = slide_index_dbl(
      hm_iqr, date,
      ~ sum(.x, na.rm = TRUE), 
      .before = BEFORE, .after = AFTER,
      .complete = T
    ),
    roll_sum_quant = slide_index_dbl(
      hm_quant, date,
      ~ sum(.x, na.rm = TRUE), 
      .before = BEFORE, .after = AFTER,
      .complete = T
    ),
    roll_prop_iqr = roll_sum_iqr/roll_sum,
    roll_prop_quant = roll_sum_quant/roll_sum,
  ) 

hot_moments <- hm_ident %>%
  group_by(date) %>%
  filter(length(unique(MIU_VALVE[!is.na(hot_moment_iqr)])) == 12) %>%
  group_by(MIU_VALVE) %>%
  summarize(
    median   = median(CH4_umol_m2_h, na.rm = TRUE),
    mean     = mean(CH4_umol_m2_h, na.rm = TRUE),
    sum      = sum(CH4_umol_m2_h, na.rm = TRUE),
    hot_sum  = sum(CH4_umol_m2_h[hot_moment_iqr == "hot"], na.rm = TRUE),
    hot_med  = median(CH4_umol_m2_h[hot_moment_iqr == "hot"], na.rm = TRUE),
    quant_95 = quantile(CH4_umol_m2_h, probs = 0.95, na.rm = TRUE)
  )

hm <- hot_moments %>%
  ggplot(aes(x = median, y = hot_sum, fill = MIU_VALVE))+
  geom_point(color = "black", shape = 21, stroke = 0.5, size = 2)+
  scale_fill_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  ylab("Sum of hot moment fluxes (top 5%)")+
  xlab("Median flux")+
  theme(panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25),
        legend.position = "bottom",
        legend.title.position = "top")+
  guides(fill = guide_legend(ncol = 2))

ggsave("../figures/Figure 3 - HM rolling.jpg", dpi = 300, width = 3.5, height = 4.5)

hm_iqr <- hot_moments %>%
  ggplot(aes(x = median, y = hot_sum/sum))+
  geom_smooth(method = "lm", color = "black")+
  geom_point(aes(fill = MIU_VALVE), color = "black", shape = 21, stroke = 0.5, size = 2)+
  scale_fill_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  ylab("Percent hot moment fluxes (by IQR)")+
  xlab("Median flux")+
  theme(panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25),
        legend.position = "bottom",
        legend.title.position = "top")+
  guides(fill = guide_legend(ncol = 2))

ggsave("../figures/Figure 3 - HM IQR rolling.jpg", dpi = 300, width = 3.5, height = 4.5)

hm_ident %>%
  ggplot(aes(x = DateTime, y = CH4_umol_m2_h))+
  geom_point(size = 0.5, data = . %>% filter(hot_moment_quant == "not"))+
  geom_point(size = 0.5, data = . %>% filter(hot_moment_quant == "hot"), color = "red")+
  facet_wrap(~MIU_VALVE, scales = "free")

hm_ident %>%
  filter(date %in% seq.Date(as.Date("2025-10-15"), as.Date("2025-11-15"), by = "1 day")) %>%
  ggplot(aes(x = DateTime, y = CH4_umol_m2_h))+
  geom_point(size = 0.5, data = . %>% filter(hot_moment_iqr == "not"))+
  geom_line()+
  geom_point(size = 0.5, data = . %>% filter(hot_moment_iqr == "hot"), color = "red")+
  facet_wrap(~MIU_VALVE, scales = "free")

hm_ident %>%
  filter(date %in% seq.Date(as.Date("2025-11-01"), as.Date("2025-11-20"), by = "1 day")) %>%
  ggplot(aes(x = DateTime, y = CH4_umol_m2_h))+
  geom_point(size = 0.5, data = . %>% filter(hot_moment_quant == "not"))+
  geom_line()+
  geom_point(size = 0.5, data = . %>% filter(hot_moment_quant == "hot"), color = "red")+
  facet_wrap(~MIU_VALVE, scales = "free")

prop <- hm_ident %>%
  ggplot(aes(x = DateTime, y = roll_sum_quant/roll_sum, color = MIU_VALVE))+
  geom_line(size = 0.3)+
  ylab("Hot moment fluxes as proportion of total")+
  #coord_cartesian(ylim = c(0,1))+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()+
  facet_wrap(~MIU_VALVE)+
  theme(legend.position = "bottom")

ggsave("../figures/Figure 3 - HM IQR rolling prop.jpg", dpi = 300, width = 5, height = 4.5)

part %>%
  group_by(date, MIU_VALVE) %>%
  filter(!GPP < 0) %>%
  summarize(GPP = max(GPP, na.rm = T)) %>%
  ggplot(aes(x = date, y = GPP, color = MIU_VALVE))+
  geom_line(size = 0.3)+
  ylab("GPP")+
  #coord_cartesian(ylim = c(0,1))+
  scale_color_manual(values = color.gradient, name = "Chamber")+
  egg::theme_article()

hm_ident %>%
  group_by(MIU_VALVE) %>%
  summarize(n_iqr = sum(hot_moment_iqr == "hot", na.rm = T),
            n_quant = sum(hot_moment_quant == "hot", na.rm = T),
            tot_iqr = sum(!is.na(hot_moment_iqr)),
            tot_quant = sum(!is.na(hot_moment_quant))) %>%
  pivot_longer(c(n_quant, n_iqr),
               names_to = "method",
               values_to = "count") %>%
  mutate(method = recode(method,
                         n_quant = "Q95",
                         n_iqr   = "IQR")) %>%
  ggplot(aes(x = MIU_VALVE, y = count/tot_quant, fill = method))+
  geom_col(position = "dodge")+
  theme(axis.text.x = element_text(angle = 90))
```

Variability increases with median (Figure 3- option 3)

```{r}
hm_df <- part

daily_summaries <- hm_df %>%
  mutate(time_join = round_date(DateTime, "15 minute")) %>%
  left_join(met, 
            by = c("time_join" = "TIMESTAMP")) %>%
  mutate(CH4_umol_m2_h = ifelse(CH4_umol_m2_h < 0, 0, CH4_umol_m2_h)) %>%
  group_by(MIU_VALVE, date) %>%
  summarize(IQR = IQR(CH4_umol_m2_h, na.rm = T),
            median = median(CH4_umol_m2_h, na.rm = T),
            max = max(CH4_umol_m2_h, na.rm = T),
            min = min(CH4_umol_m2_h, na.rm = T),
            GPP = median(GPP, na.rm = T),
            AirT = median(AirTC_Avg, na.rm = T))

daily_summaries %>%
  ggplot(aes(x = median, y = IQR, color = AirT))+
  geom_point()+
  facet_wrap(~MIU_VALVE)+
  egg::theme_article()+
  scale_color_viridis_c()

daily_summaries %>%
  ggplot(aes(x = median, y = IQR, color = AirT))+
  geom_smooth(aes(color = MIU_VALVE), method = "lm")+
  egg::theme_article()+
  scale_color_manual(values = color.gradient, name = "Chamber")

daily_summaries %>%
  ggplot(aes(x = median, y = IQR))+
  geom_point()+
  geom_smooth(aes(color = MIU_VALVE), method = "lm")+
  facet_wrap(~MIU_VALVE)+
  egg::theme_article()+
  scale_color_manual(values = color.gradient, name = "Chamber")

daily_summaries %>%
  ggplot(aes(x = min, y = max))+
  geom_point()+
  geom_smooth(aes(color = MIU_VALVE), method = "lm")+
  facet_wrap(~MIU_VALVE, scales = "free")+
  egg::theme_article()+
  scale_color_manual(values = color.gradient, name = "Chamber")
```

Because of hot moments, manual sampling underestimates fluxes (Figure 4)

```{r}
reps <-  100
samples_per_week <- 1

df <- hm_df %>%
  mutate(week = week(date)) 

calc_mean_flux <- function(ch4_vals, n){
  vals <- sample(ch4_vals, n)
  return(mean(vals))
}

df_out_daytime <- df %>%
  filter(hour(DateTime) >= 9,
         hour(DateTime) <= 15) %>%
  group_by(week) %>%
  cross_join(data.frame(rep = 1:reps)) %>%
  group_by(week, MIU_VALVE, rep) %>%
  summarize(flux = calc_mean_flux(CH4_umol_m2_h, samples_per_week)) %>%
  mutate(time = "daytime")

df_out_fullday <- df %>%
  group_by(week) %>%
  cross_join(data.frame(rep = 1:reps)) %>%
  group_by(week, MIU_VALVE, rep) %>%
  summarize(flux = calc_mean_flux(CH4_umol_m2_h, samples_per_week)) %>% 
  mutate(time = "full day")

df_out_rain <- df %>%
  mutate(time_join = round_date(DateTime, "15 minute")) %>%
  left_join(met %>%
              arrange(TIMESTAMP) %>%
              mutate(
                Rain_cm_roll =
                  slider::slide_dbl(Rain_cm_Tot,
                            sum,
                            .before = 3,
                            .complete = TRUE)
              ), 
            by = c("time_join" = "TIMESTAMP")) %>%
  filter(Rain_cm_roll == 0) %>%
  group_by(week) %>%
  cross_join(data.frame(rep = 1:reps)) %>%
  group_by(week, MIU_VALVE, rep) %>%
  summarize(flux = calc_mean_flux(CH4_umol_m2_h, samples_per_week)) %>% 
  mutate(time = "rain")

df_out_growth <- df %>%
  filter(month(DateTime) %in% 5:9) %>%
  group_by(week) %>%
  cross_join(data.frame(rep = 1:reps)) %>%
  group_by(week, MIU_VALVE, rep) %>%
  summarize(flux = calc_mean_flux(CH4_umol_m2_h, samples_per_week)) %>%
  mutate(time = "growth")

df_out_wl <- df %>%
  mutate(time_join = round_date(DateTime, "15 minute")) %>%
  left_join(wl, by = c("time_join" = "TIMESTAMP")) %>%
  filter(Depth_cm < 0) %>%
  group_by(week) %>%
  cross_join(data.frame(rep = 1:reps)) %>%
  group_by(week, MIU_VALVE, rep) %>%
  summarize(flux = calc_mean_flux(CH4_umol_m2_h, samples_per_week)) %>%
  mutate(time = "wl")

df_out <- df_out_daytime  %>%
  bind_rows(df_out_fullday) %>%
  #bind_rows(df_out_rain) %>%
  bind_rows(df_out_growth) %>%
  bind_rows(df_out_wl)

to_plot <- df_out %>%
  group_by(MIU_VALVE, rep, time) %>%
  summarize(mean = mean(flux, na.rm = T)) %>%
  left_join(hot_moments %>% 
              rename(tot_real = sum,
                     mean_real = mean)) %>%
  group_by(MIU_VALVE, time) %>%
  summarize(median = median(mean/mean_real * 100 - 100))

sims <- to_plot %>%
  mutate(time = factor(time, 
                       levels = c("full day", "wl", "daytime", "growth"),
                       labels = c("Weekly (all)", "No standing\nwater",
                                  "Daytime", "Growing\nseason"))) %>%
  ggplot(aes(x = time, y = median))+
  geom_hline(yintercept = 0, color = "grey80")+
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = MIU_VALVE),
              width = 0.2, shape = 21, color = "black")+
  scale_fill_manual(values = color.gradient,
                    name = "Chamber")+
  egg::theme_article()+
  theme(panel.grid.major = element_line(color = "grey93", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25),
        axis.title.x = element_blank(),
        legend.title.position = "top")+
  ylab("Percent difference in mean flux\nbetween manual and high-frequency\nsampling (median of 100 simulations)")
sims
ggsave("../figures/Figure 4 - Simulations.jpg", dpi = 300, width = 6, height = 3)
```

However, the magnitude of methane emitted is poorly predicted by the magnitude of change in water level (Figure 5)

```{r}
with_wl <- part %>%
  mutate(time_join = round_date(DateTime, "15 minute")) %>%
  left_join(wl, by = c("time_join" = "TIMESTAMP"))

with_wl %>%
  ggplot(aes(x = Depth_cm, y = CH4_umol_m2_h))+
  geom_point()

with_wl %>%
  mutate(Depth_change_cm = Depth_cm - lag(Depth_cm),
         month = month(date)) %>%
  ggplot(aes(x = Depth_change_cm, y = CH4_umol_m2_h))+
  geom_point()+
  facet_grid(MIU_VALVE~month, scales = "free")
```

Model hm separately
```{r}
mod_df <- hm_ident %>%
  mutate(time_join = round_date(DateTime, "15 minute")) %>%
  left_join(wl, by = c("time_join" = "TIMESTAMP")) %>%
  left_join(met, by = c("time_join" = "TIMESTAMP")) %>%
  group_by(MIU_VALVE) %>%
  mutate(Depth_change = Depth_cm - lag(Depth_cm))

data_not = mod_df %>%
  filter(hot_moment_iqr == "not") %>%
  select(c(CH4_umol_m2_h, Depth_cm, AirTC_Avg, Depth_change)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(MIU_VALVE == "Ch. 12 (+6.0 ºC)") %>%
  select(-MIU_VALVE)

preds_not <- randomForest::randomForest(CH4_umol_m2_h~Depth_cm + AirTC_Avg + Depth_change,
                                        data = data_not,
                                        importance = T)
randomForest::importance(preds_not)
preds_not$rsq[length(preds_not$rsq)]

data_hot = mod_df %>%
  filter(hot_moment_iqr == "hot") %>%
  select(c(CH4_umol_m2_h, Depth_cm, AirTC_Avg, Depth_change)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(MIU_VALVE == "Ch. 12 (+6.0 ºC)") %>%
  select(-MIU_VALVE)

preds_hot <- randomForest::randomForest(CH4_umol_m2_h~Depth_cm + AirTC_Avg + Depth_change,
                                        data = data_hot,
                                        importance = T)
randomForest::importance(preds_hot)
preds_hot$rsq[length(preds_not$rsq)]

data_class = mod_df %>%
  select(c(Depth_cm, AirTC_Avg, Depth_change, hot_moment_iqr)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(MIU_VALVE == "Ch. 12 (+6.0 ºC)") %>%
  select(-MIU_VALVE) %>%
  mutate(hot_moment_iqr = as.factor(hot_moment_iqr))
preds_class <- randomForest::randomForest(hot_moment_iqr~Depth_cm + AirTC_Avg + Depth_change,
                                        data = data_class,
                                        importance = T,
                                        classwt = c(not = 1, hot = 19))
randomForest::importance(preds_class)
preds_class$err.rate[nrow(preds_class$err.rate),]
```

